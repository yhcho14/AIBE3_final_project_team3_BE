name: CD - Deploy to Production

on:
  push:
    branches: [ prod ]

jobs:
  wait-for-ci:
    name: Wait for CI
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI workflow
        uses: lewagon/wait-on-check-action@v1.3.1
        with:
          ref: ${{ github.ref }}
          check-name: 'Run Integration Tests'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

  deploy-production:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    needs: wait-for-ci
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to production server via SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.PROD_SERVER_HOST }}
          SERVER_USER: ${{ secrets.PROD_SERVER_USER }}
        run: |
          # Convert repository name to lowercase
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
          
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << ENDSSH
            set -e
            cd /opt/app/production
            
            # Login to GHCR
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull latest production image
            docker pull ghcr.io/${REPO_LOWER}:prod-latest
            
            # Update docker-compose and restart
            docker compose down
            docker compose up -d
            
            # Cleanup old images
            docker image prune -f
            
            echo "âœ… Production deployment completed"
          ENDSSH

      - name: Verify production deployment
        env:
          SERVER_HOST: ${{ secrets.PROD_SERVER_HOST }}
          SERVER_USER: ${{ secrets.PROD_SERVER_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            cd /opt/app/production
            echo "ðŸ“Š Container Status:"
            docker compose ps
            echo ""
            echo "ðŸ“ Recent Logs:"
            docker compose logs --tail=50
          ENDSSH

      - name: Notification on success
        if: success()
        run: echo "âœ… Production deployment successful!"

      - name: Notification on failure
        if: failure()
        run: echo "âŒ Production deployment failed!"
